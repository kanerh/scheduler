<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>מתאם פגישות (מקומי)</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #f6f7fb; color: #111; }
    header { position: sticky; top: 0; z-index: 10; background: #fff; border-bottom: 1px solid #e6e7ee; }
    header .wrap { max-width: 980px; margin: 0 auto; padding: 14px 16px; display:flex; gap:12px; align-items:center; justify-content:space-between; }
    .brand { font-weight: 800; letter-spacing: .2px; }
    main { max-width: 980px; margin: 0 auto; padding: 16px; display: grid; gap: 14px; }
    .card { background: #fff; border: 1px solid #e6e7ee; border-radius: 16px; padding: 14px; box-shadow: 0 1px 0 rgba(0,0,0,.02); }
    .row { display:flex; gap:10px; flex-wrap: wrap; align-items:flex-end; }
    .col { flex: 1 1 220px; min-width: 220px; }
    label { display:block; font-size: 12px; color:#333; margin-bottom: 6px; }
    input[type="text"], input[type="date"], input[type="time"], textarea, select {
      width: 100%; padding: 10px 12px; border-radius: 12px; border: 1px solid #d7d9e3; background:#fff; outline:none;
    }
    textarea { min-height: 76px; resize: vertical; }
    .btn { appearance:none; border: 0; border-radius: 12px; padding: 10px 12px; background:#111; color:#fff; font-weight: 700; cursor:pointer; }
    .btn.secondary { background: #fff; color:#111; border: 1px solid #d7d9e3; }
    .btn.danger { background: #b00020; }
    .btn:disabled { opacity:.55; cursor:not-allowed; }
    .muted { color:#666; font-size: 12px; }
    .pill { display:inline-flex; align-items:center; gap:6px; border:1px solid #e6e7ee; background:#fafbff; border-radius: 999px; padding: 6px 10px; font-size: 12px; }
    .grid { display:grid; gap:12px; }
    .grid2 { display:grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 860px) { .grid2 { grid-template-columns: 1fr 1fr; } }
    .sep { height:1px; background:#eef0f7; margin: 10px 0; }
    .alert { border-radius: 14px; padding: 10px 12px; border: 1px solid #f1c1c7; background: #fff5f6; color:#7a0016; }
    .ok { border: 1px solid #cde8d3; background:#f2fff5; color:#0b5a1b; }
    .small { font-size: 12px; }
    .table { width:100%; border-collapse: collapse; overflow:auto; display:block; }
    .table th, .table td { padding: 10px 10px; border-bottom: 1px solid #eef0f7; text-align:right; vertical-align: top; }
    .table th { position: sticky; top: 0; background:#fff; z-index: 1; font-size: 12px; color:#333; }
    .nowrap { white-space: nowrap; }
    .voteBadge { display:inline-flex; align-items:center; gap:6px; padding: 4px 8px; border-radius: 999px; border:1px solid #e6e7ee; font-size: 12px; background:#fff; }
    .vote-good { border-color:#bfe6c7; background:#f2fff5; }
    .vote-maybe { border-color:#ffe7a3; background:#fffaf0; }
    .vote-no { border-color:#f2b8c2; background:#fff5f6; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .right { display:flex; gap:8px; align-items:center; }
    .hint { background:#f0f3ff; border:1px solid #d6defc; color:#1b2a6d; border-radius: 14px; padding: 10px 12px; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; border:1px solid #d7d9e3; padding: 1px 6px; border-radius: 8px; background:#fff; }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">מתאם פגישות (מקומי)</div>
    <div class="right">
      <button class="btn secondary" id="homeBtn" type="button">מסך ראשי</button>
      <button class="btn secondary" id="resetBtn" type="button" title="מוחק את כל הנתונים המקומיים">איפוס</button>
    </div>
  </div>
</header>

<main id="app"></main>

<script>
const APP_TTL_DAYS = 3;
const MAX_OPTIONS = 5;

const Vote = { GOOD: "good", MAYBE: "maybe", NO: "no" };
const VoteLabel = { good: "סבבה", maybe: "לא להיט אבל אפשרי", no: "לא זמין" };
function voteScore(v){ return v === Vote.GOOD ? 1 : v === Vote.MAYBE ? 0.5 : 0; }

function qs(sel){ return document.querySelector(sel); }
function el(tag, attrs = {}, ...children){
  const n = document.createElement(tag);
  for (const [k,v] of Object.entries(attrs)){
    if (k === "class") n.className = v;
    else if (k === "html") n.innerHTML = v;
    else if (k.startsWith("on") && typeof v === "function") n.addEventListener(k.slice(2), v);
    else n.setAttribute(k, v);
  }
  for (const c of children){
    if (c == null) continue;
    n.appendChild(typeof c === "string" ? document.createTextNode(c) : c);
  }
  return n;
}

function now(){ return Date.now(); }
function shortId(len=6){ return Array.from({length: len}, ()=> Math.floor(Math.random()*36).toString(36)).join(""); }

function parseUrl(){
  const u = new URL(location.href);
  return { meetingId: u.searchParams.get("m") || "" };
}
function setUrlMeeting(id){
  const u = new URL(location.href);
  u.searchParams.set("m", id);
  history.pushState({}, "", u.toString());
}
function clearUrlMeeting(){
  const u = new URL(location.href);
  u.searchParams.delete("m");
  history.pushState({}, "", u.toString());
}

function toLocalTs(dateStr, timeStr){
  const [y,m,d] = dateStr.split("-").map(Number);
  const [hh,mm] = timeStr.split(":").map(Number);
  return new Date(y, m-1, d, hh, mm, 0, 0).getTime();
}

function formatOption(opt){
  const [y,m,d] = opt.date.split("-").map(Number);
  const dd = String(d).padStart(2,"0");
  const mm2 = String(m).padStart(2,"0");
  return `${dd}/${mm2}/${y} · ${opt.startTime}–${opt.endTime}`;
}

function ensureMeetingShape(m){
  if (!m.options) m.options = [];
  if (!m.participants) m.participants = {};
  if (!m.activityLog) m.activityLog = [];
  for (const opt of m.options){
    if (!opt.votes) opt.votes = {};
  }
  return m;
}
function meetingExpired(m){ return now() > (m.expiresAt || 0); }
function addLog(m, action, by, meta = {}){
  m.activityLog.unshift({ timestamp: now(), action, by: by || "מערכת", meta });
}

function computeOptionRanking(meeting){
  const mandatoryNames = Object.entries(meeting.participants)
    .filter(([_,p])=> !!p.mandatory)
    .map(([name])=> name);
  const allNames = Object.keys(meeting.participants);

  const items = meeting.options.map(opt => {
    let mandatoryGood = 0;
    for (const name of mandatoryNames){
      const v = opt.votes?.[name];
      if (v === Vote.GOOD) mandatoryGood++;
    }
    let total = 0;
    for (const name of allNames){
      total += voteScore(opt.votes?.[name]);
    }
    const key = `${opt.date || ""}T${opt.startTime || ""}`;
    return { opt, mandatoryGood, total, key };
  });

  items.sort((a,b)=>{
    if (b.mandatoryGood !== a.mandatoryGood) return b.mandatoryGood - a.mandatoryGood;
    if (b.total !== a.total) return b.total - a.total;
    return a.key.localeCompare(b.key);
  });

  const hasPerfectMandatory =
    mandatoryNames.length === 0 ? true :
    meeting.options.some(opt => mandatoryNames.every(n => opt.votes?.[n] === Vote.GOOD));

  return { items, mandatoryNames, hasPerfectMandatory };
}

const STORE_KEY = "meeting_picker_local_v2";
function loadStore(){
  const raw = localStorage.getItem(STORE_KEY);
  if (!raw) return { meetings: {}, ui: {} };
  try{
    const json = JSON.parse(raw);
    if (!json.meetings) json.meetings = {};
    if (!json.ui) json.ui = {};
    return json;
  } catch {
    return { meetings: {}, ui: {} };
  }
}
function saveStore(store){ localStorage.setItem(STORE_KEY, JSON.stringify(store)); }
function purgeExpired(store){
  for (const [mid, m] of Object.entries(store.meetings || {})){
    if (m && meetingExpired(m)) delete store.meetings[mid];
  }
}

function setMain(children){
  const app = qs("#app");
  app.innerHTML = "";
  for (const c of children) app.appendChild(c);
}
function renderVoteBadge(v){
  const cls = v === Vote.GOOD ? "voteBadge vote-good" :
              v === Vote.MAYBE ? "voteBadge vote-maybe" :
              "voteBadge vote-no";
  return el("span", { class: cls }, VoteLabel[v] || "");
}

function renderHome(){
  const store = loadStore();
  purgeExpired(store);
  saveStore(store);

  const title = el("input", { type:"text", placeholder:"למשל: ישיבת סטטוס", autocomplete:"off" });

  const participantsText = el("textarea", {
    placeholder:"שמות משתתפים – אחד בכל שורה.\nסמן חובה עם ! בתחילת השורה.\nדוגמה:\n!דני\nרותם"
  });

  const optionsWrap = el("div", { class:"grid" });
  const addOptBtn = el("button", { class:"btn secondary", type:"button" }, "הוסף מועד");
  const createBtn = el("button", { class:"btn", type:"button" }, "צור פגישה");

  function optionRow(){
    const d = el("input", { type:"date" });
    const st = el("input", { type:"time" });
    const et = el("input", { type:"time" });
    const rm = el("button", { class:"btn danger secondary", type:"button" }, "הסר");
    const row = el("div", { class:"row" },
      el("div",{class:"col"}, el("label",{}, "תאריך"), d),
      el("div",{class:"col"}, el("label",{}, "שעת התחלה"), st),
      el("div",{class:"col"}, el("label",{}, "שעת סיום"), et),
      el("div",{class:"col", style:"flex:0 0 auto; min-width:auto;"}, rm)
    );
    rm.addEventListener("click", ()=> { row.remove(); refreshAddBtn(); });
    return row;
  }

  function refreshAddBtn(){
    const count = optionsWrap.querySelectorAll(".row").length;
    addOptBtn.disabled = count >= MAX_OPTIONS;
  }

  optionsWrap.appendChild(optionRow());
  optionsWrap.appendChild(optionRow());
  refreshAddBtn();

  addOptBtn.addEventListener("click", ()=>{
    if (optionsWrap.querySelectorAll(".row").length >= MAX_OPTIONS) return;
    optionsWrap.appendChild(optionRow());
    refreshAddBtn();
  });

  createBtn.addEventListener("click", ()=>{
    const meetingTitle = title.value.trim();
    if (!meetingTitle){ alert("יש למלא נושא פגישה"); return; }

    const rows = Array.from(optionsWrap.querySelectorAll(".row"));
    const options = [];
    for (const row of rows){
      const inputs = row.querySelectorAll("input");
      const date = inputs[0].value;
      const startTime = inputs[1].value;
      const endTime = inputs[2].value;
      if (!date || !startTime || !endTime) continue;
      const sTs = toLocalTs(date, startTime);
      const eTs = toLocalTs(date, endTime);
      if (eTs <= sTs){ alert("שעת סיום חייבת להיות אחרי שעת ההתחלה"); return; }
      options.push({ id: "opt_" + shortId(5), date, startTime, endTime, votes: {} });
    }
    if (options.length === 0){ alert("יש להוסיף לפחות מועד אחד"); return; }
    if (options.length > MAX_OPTIONS){ alert("מקסימום 5 מועדים"); return; }

    const participantsLines = participantsText.value.split("\n").map(x=>x.trim()).filter(Boolean);
    const participants = {};
    for (const line of participantsLines){
      const mandatory = line.startsWith("!");
      const name = (mandatory ? line.slice(1) : line).trim();
      if (!name) continue;
      participants[name] = { mandatory };
    }

    const id = shortId(6);
    const createdAt = now();
    const expiresAt = createdAt + APP_TTL_DAYS * 24*60*60*1000;

    const meeting = ensureMeetingShape({ id, title: meetingTitle, createdAt, expiresAt, options, participants, activityLog: [] });
    addLog(meeting, "meeting_create", "מערכת", { title: meetingTitle });

    store.meetings[id] = meeting;
    saveStore(store);

    setUrlMeeting(id);
    renderMeeting(id);
  });

  const existing = Object.values(store.meetings || {}).sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));
  const list = el("div",{class:"grid", style:"gap:10px;"});
  if (existing.length){
    for (const m of existing){
      list.appendChild(
        el("div",{class:"card"},
          el("div",{style:"font-weight:800;"}, m.title || "פגישה"),
          el("div",{class:"muted small", style:"margin-top:6px;"},
            "מזהה: ", el("span",{class:"mono"}, m.id),
            " · תפוגה: ", new Date(m.expiresAt).toLocaleString("he-IL")
          ),
          el("div",{style:"margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;"},
            el("button",{class:"btn secondary", type:"button", onclick: ()=>{ setUrlMeeting(m.id); renderMeeting(m.id); }}, "פתח"),
            el("button",{class:"btn danger secondary", type:"button", onclick: ()=>{
              if (!confirm("למחוק את הפגישה המקומית?")) return;
              delete store.meetings[m.id];
              // ננקה גם בחירת משתתף שמורה אם מצביעה על פגישה שנמחקה
              if (store.ui?.selectedParticipantByMeeting?.[m.id]) {
                delete store.ui.selectedParticipantByMeeting[m.id];
              }
              saveStore(store);
              renderHome();
            }}, "מחק")
          )
        )
      );
    }
  } else {
    list.appendChild(el("div",{class:"muted small"}, "אין פגישות שמורות מקומית עדיין."));
  }

  setMain([
    el("div",{class:"card hint"},
      el("div",{style:"font-weight:800; margin-bottom:6px;"}, "מצב מקומי בלבד"),
      el("div",{class:"small"},
        "הנתונים נשמרים ב-", el("span",{class:"mono"},"localStorage"),
        " בדפדפן שלך. אין שיתוף בין אנשים."
      )
    ),
    el("div", { class:"card" },
      el("div", { style:"font-weight:800; margin-bottom:8px;" }, "יצירת פגישה"),
      el("div", { class:"grid" },
        el("div", {}, el("label",{}, "נושא הפגישה"), title),
        el("div", {},
          el("label",{}, `מועדים אפשריים (עד ${MAX_OPTIONS})`),
          optionsWrap,
          el("div", { style:"margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;" }, addOptBtn),
          el("div", { class:"muted", style:"margin-top:8px;" }, "אחרי יצירה: ניתן להוסיף מועדים (לא למחוק).")
        ),
        el("div", {}, el("label",{}, "משתתפים (אחד בכל שורה)"), participantsText),
        el("div", { style:"display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-start;" }, createBtn)
      )
    ),
    el("div",{class:"card"},
      el("div",{style:"font-weight:800; margin-bottom:8px;"}, "פגישות מקומיות"),
      list
    )
  ]);
}

function renderMeeting(meetingId){
  const store = loadStore();
  purgeExpired(store);
  saveStore(store);

  const meeting = store.meetings?.[meetingId];
  if (!meeting){
    setMain([ el("div",{class:"card alert"}, "הפגישה לא נמצאה (ייתכן שנמחקה/פגה).") ]);
    return;
  }
  ensureMeetingShape(meeting);

  if (meetingExpired(meeting)){
    delete store.meetings[meetingId];
    if (store.ui?.selectedParticipantByMeeting?.[meetingId]) {
      delete store.ui.selectedParticipantByMeeting[meetingId];
    }
    saveStore(store);
    setMain([ el("div",{class:"card alert"}, "פגישה זו פגה תוקף ונמחקה אוטומטית מקומית.") ]);
    return;
  }

  store.ui = store.ui || {};
  store.ui.selectedParticipantByMeeting = store.ui.selectedParticipantByMeeting || {};

  function persist(){
    purgeExpired(store);
    store.meetings[meetingId] = meeting;
    saveStore(store);
  }

  // בחירת משתמש מתוך רשימה
  const participantSelect = el("select", {});
  participantSelect.appendChild(el("option",{value:""}, "בחר/י את שמך מהרשימה..."));

  const participantNames = Object.keys(meeting.participants || {}).sort((a,b)=>a.localeCompare(b));
  for (const name of participantNames){
    participantSelect.appendChild(el("option",{value:name}, name));
  }

  // שחזור בחירה קודמת (לוקאלית בלבד)
  const savedSel = store.ui.selectedParticipantByMeeting[meetingId] || "";
  if (savedSel && meeting.participants[savedSel]) participantSelect.value = savedSel;

  participantSelect.addEventListener("change", ()=>{
    store.ui.selectedParticipantByMeeting[meetingId] = participantSelect.value || "";
    saveStore(store);
    renderMeeting(meetingId);
  });

  function getSelectedParticipant(){
    const p = participantSelect.value || "";
    return p;
  }

  function ensureParticipantSelected(){
    const me = getSelectedParticipant();
    if (!me){
      alert("נא לבחור את שמך מהרשימה לפני הצבעה.");
      return false;
    }
    return true;
  }

  function updateVote(optionId, vote){
    if (!ensureParticipantSelected()) return;
    const me = getSelectedParticipant();

    const opt = meeting.options.find(o=>o.id === optionId);
    if (!opt) return;
    const prev = opt.votes?.[me];
    opt.votes = opt.votes || {};
    opt.votes[me] = vote;

    addLog(meeting, prev ? "vote_update" : "vote_add", me, { optionId, vote });
    persist();
    renderMeeting(meetingId);
  }

  // Participants management
  const participantsList = el("div", { class:"grid", style:"gap:8px;" });

  function rebuildParticipantsUI(){
    participantsList.innerHTML = "";
    const entries = Object.entries(meeting.participants || {});
    if (!entries.length){
      participantsList.appendChild(el("div",{class:"muted small"}, "אין משתתפים מוגדרים עדיין. הוסף משתתפים כדי לאפשר הצבעה."));
      return;
    }
    for (const [pname, p] of entries.sort((a,b)=> a[0].localeCompare(b[0]))){
      const mand = el("input", { type:"checkbox" });
      mand.checked = !!p.mandatory;
      mand.addEventListener("change", ()=>{
        meeting.participants[pname].mandatory = mand.checked;
        addLog(meeting, "participant_update", pname, { mandatory: mand.checked });
        persist();
        renderMeeting(meetingId);
      });

      const del = el("button", { class:"btn danger secondary", type:"button" }, "מחק");
      del.addEventListener("click", ()=>{
        if (!confirm(`למחוק את ${pname} ואת ההצבעות שלו?`)) return;

        delete meeting.participants[pname];
        for (const opt of meeting.options){
          if (opt.votes) delete opt.votes[pname];
        }

        // אם המשתתף שנבחר נמחק — ננקה בחירה
        if (store.ui.selectedParticipantByMeeting[meetingId] === pname){
          store.ui.selectedParticipantByMeeting[meetingId] = "";
        }

        addLog(meeting, "participant_delete", pname, {});
        persist();
        saveStore(store);
        renderMeeting(meetingId);
      });

      participantsList.appendChild(
        el("div",{class:"row"},
          el("div",{class:"col"},
            el("div",{style:"font-weight:800;"}, pname),
            el("div",{class:"muted small"}, p.mandatory ? "חובה (Mandatory)" : "אופציונלי")
          ),
          el("div",{class:"col", style:"flex:0 0 auto; min-width:auto; display:flex; gap:10px; align-items:center;"},
            el("label",{style:"margin:0; display:flex; gap:8px; align-items:center; cursor:pointer;"},
              mand, el("span",{class:"small"}, "חובה")
            ),
            del
          )
        )
      );
    }
  }

  const addPName = el("input", { type:"text", placeholder:"שם משתתף" });
  const addPMand = el("input", { type:"checkbox" });
  const addPBtn = el("button", { class:"btn secondary", type:"button" }, "הוסף משתתף");

  addPBtn.addEventListener("click", ()=>{
    const pname = addPName.value.trim();
    if (!pname) return;
    if (meeting.participants[pname]){
      alert("המשתתף כבר קיים.");
      return;
    }
    meeting.participants[pname] = { mandatory: addPMand.checked };
    addLog(meeting, "participant_add", pname, { mandatory: addPMand.checked });
    persist();

    // ברירת מחדל: אם עדיין לא נבחר משתתף, נבחר את הראשון שהוסף
    if (!store.ui.selectedParticipantByMeeting[meetingId]){
      store.ui.selectedParticipantByMeeting[meetingId] = pname;
      saveStore(store);
    }

    renderMeeting(meetingId);
  });

  // Add option (cannot delete)
  const addOD = el("input", { type:"date" });
  const addOST = el("input", { type:"time" });
  const addOET = el("input", { type:"time" });
  const addOBtn = el("button", { class:"btn secondary", type:"button" }, "הוסף מועד");
  addOBtn.disabled = meeting.options.length >= MAX_OPTIONS;

  addOBtn.addEventListener("click", ()=>{
    if (meeting.options.length >= MAX_OPTIONS) return;
    if (!addOD.value || !addOST.value || !addOET.value){ alert("בחר תאריך + התחלה + סיום"); return; }
    const sTs = toLocalTs(addOD.value, addOST.value);
    const eTs = toLocalTs(addOD.value, addOET.value);
    if (eTs <= sTs){ alert("שעת סיום חייבת להיות אחרי שעת ההתחלה"); return; }

    const opt = { id: "opt_" + shortId(5), date: addOD.value, startTime: addOST.value, endTime: addOET.value, votes: {} };
    meeting.options.push(opt);

    const by = getSelectedParticipant() || "משתתף";
    addLog(meeting, "option_add", by, { option: opt });

    persist();
    renderMeeting(meetingId);
  });

  // My votes cards (based on selected participant)
  const voteCardWrap = el("div", { class:"grid" });
  function buildVoteCards(){
    voteCardWrap.innerHTML = "";

    const me = getSelectedParticipant(); // may be ""
    if (!participantNames.length){
      voteCardWrap.appendChild(el("div",{class:"alert"}, "אין משתתפים. הוסף משתתפים כדי לאפשר הצבעה."));
      return;
    }
    if (!me){
      voteCardWrap.appendChild(el("div",{class:"alert"}, "בחר/י את שמך מהרשימה כדי להצביע."));
    }

    for (const opt of meeting.options){
      const current = me ? (opt.votes?.[me] || "") : "";

      const sel = el("select", {});
      sel.appendChild(el("option",{value:""}, "בחר..."));
      sel.appendChild(el("option",{value:Vote.GOOD}, VoteLabel[Vote.GOOD]));
      sel.appendChild(el("option",{value:Vote.MAYBE}, VoteLabel[Vote.MAYBE]));
      sel.appendChild(el("option",{value:Vote.NO}, VoteLabel[Vote.NO]));
      sel.value = current;
      sel.disabled = !me;

      sel.addEventListener("change", ()=> { if (sel.value) updateVote(opt.id, sel.value); });

      voteCardWrap.appendChild(
        el("div",{class:"card"},
          el("div",{style:"font-weight:800; margin-bottom:6px;"}, formatOption(opt)),
          el("div",{class:"muted small", style:"margin-bottom:8px;"}, me ? `הצבעה עבור: ${me}` : "בחר/י משתתף כדי להצביע"),
          sel,
          me && current ? el("div",{style:"margin-top:10px;"}, renderVoteBadge(current)) : null
        )
      );
    }
  }

  function buildMatrix(){
    const names = Object.keys(meeting.participants || {}).sort((a,b)=>a.localeCompare(b));
    if (meeting.options.length === 0) return el("div",{class:"muted"}, "אין מועדים.");

    const table = el("table",{class:"table"});
    const thead = el("thead");
    const hrow = el("tr");
    hrow.appendChild(el("th",{class:"nowrap"}, "מועד (התחלה–סיום)"));
    for (const n of names){
      const p = meeting.participants[n] || {};
      hrow.appendChild(el("th",{class:"nowrap"}, n + (p.mandatory ? " ★" : "")));
    }
    thead.appendChild(hrow);
    table.appendChild(thead);

    const tbody = el("tbody");
    for (const opt of meeting.options){
      const tr = el("tr");
      tr.appendChild(el("td",{class:"nowrap"}, formatOption(opt)));
      for (const n of names){
        const v = opt.votes?.[n] || "";
        tr.appendChild(el("td",{}, v ? renderVoteBadge(v) : el("span",{class:"muted small"}, "—")));
      }
      tbody.appendChild(tr);
    }
    table.appendChild(tbody);
    return table;
  }

  function buildOptimization(){
    const { items, mandatoryNames, hasPerfectMandatory } = computeOptionRanking(meeting);
    const wrap = el("div",{class:"grid", style:"gap:10px;"});
    wrap.appendChild(
      hasPerfectMandatory
        ? el("div",{class:"alert ok"}, "נמצאה לפחות חלופה אחת שבה כל משתתפי החובה זמינים כ-'סבבה' (או שאין משתתפי חובה).")
        : el("div",{class:"alert"}, "אין חלופה מושלמת (לא כל משתתפי החובה סימנו 'סבבה'). מוצגות החלופות הטובות ביותר לפי הדירוג.")
    );
    wrap.appendChild(
      mandatoryNames.length
        ? el("div",{class:"muted small"}, "משתתפי חובה: " + mandatoryNames.join(", "))
        : el("div",{class:"muted small"}, "אין משתתפי חובה בפגישה זו.")
    );
    for (const it of items){
      wrap.appendChild(
        el("div",{class:"card"},
          el("div",{style:"display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap;"},
            el("div",{style:"font-weight:800;"}, formatOption(it.opt)),
            el("div",{class:"pill"}, el("span",{}, "Mandatory סבבה: "), el("strong",{}, String(it.mandatoryGood)))
          ),
          el("div",{class:"muted small", style:"margin-top:8px;"},
            "ציון כולל (סבבה=1, אפשרי=0.5, לא זמין=0): ",
            el("strong",{}, String(it.total))
          )
        )
      );
    }
    return wrap;
  }

  function buildActivity(){
    const list = el("div",{class:"grid", style:"gap:8px;"});
    const log = meeting.activityLog || [];
    if (log.length === 0){
      list.appendChild(el("div",{class:"muted small"}, "אין פעילות עדיין."));
      return list;
    }
    for (const item of log.slice(0, 60)){
      const when = new Date(item.timestamp).toLocaleString("he-IL");
      list.appendChild(el("div",{class:"pill", style:"justify-content:space-between; gap:10px;"},
        el("span",{}, `${when} · ${item.action}`),
        el("span",{class:"mono"}, item.by || "")
      ));
    }
    return list;
  }

  rebuildParticipantsUI();
  buildVoteCards();

  const topCard = el("div",{class:"card"},
    el("div",{style:"font-weight:900; font-size:18px;"}, meeting.title || "פגישה"),
    el("div",{class:"muted small", style:"margin-top:6px;"},
      "מזהה פגישה (מקומי): ", el("span",{class:"mono"}, meetingId),
      " · תפוגה: ", new Date(meeting.expiresAt).toLocaleString("he-IL")
    ),
    el("div",{class:"sep"}),
    el("div",{class:"alert"}, "מצב מקומי בלבד: השינויים נשמרים רק בדפדפן הזה (localStorage).")
  );

  const voteCard = el("div",{class:"card"},
    el("div",{style:"font-weight:800; margin-bottom:8px;"}, "הצבעה"),
    el("div",{class:"row"},
      el("div",{class:"col"},
        el("label",{}, "בחר/י את שמך מהרשימה"),
        participantSelect
      ),
    ),
    el("div",{class:"muted small", style:"margin-top:8px;"},
      "אין הקלדת שם — רק בחירה מתוך המשתתפים."
    ),
    el("div",{class:"sep"}),
    voteCardWrap
  );

  const participantsCard = el("div",{class:"card"},
    el("div",{style:"font-weight:800; margin-bottom:8px;"}, "משתתפים"),
    el("div",{class:"row"},
      el("div",{class:"col"}, el("label",{}, "שם"), addPName),
      el("div",{class:"col", style:"flex:0 0 auto; min-width:auto;"},
        el("label",{style:"margin-bottom:6px;"}, "חובה"), addPMand
      ),
      el("div",{class:"col", style:"flex:0 0 auto; min-width:auto;"}, addPBtn),
    ),
    el("div",{class:"sep"}),
    participantsList
  );

  const optionsCard = el("div",{class:"card"},
    el("div",{style:"font-weight:800; margin-bottom:8px;"}, `מועדים (עד ${MAX_OPTIONS})`),
    el("div",{class:"row"},
      el("div",{class:"col"}, el("label",{}, "תאריך"), addOD),
      el("div",{class:"col"}, el("label",{}, "שעת התחלה"), addOST),
      el("div",{class:"col"}, el("label",{}, "שעת סיום"), addOET),
      el("div",{class:"col", style:"flex:0 0 auto; min-width:auto;"}, addOBtn),
    ),
    el("div",{class:"muted small", style:"margin-top:8px;"}, "ניתן להוסיף מועדים. לא ניתן למחוק מועדים קיימים.")
  );

  const optCard = el("div",{class:"card"},
    el("div",{style:"font-weight:800; margin-bottom:8px;"}, "החלופות האופטימליות"),
    buildOptimization()
  );

  const matrixCard = el("div",{class:"card"},
    el("div",{style:"font-weight:800; margin-bottom:8px;"}, "טבלת זמינות מלאה"),
    el("div",{class:"muted small", style:"margin-bottom:8px;"}, "★ = חובה (Mandatory)"),
    buildMatrix()
  );

  const logCard = el("div",{class:"card"},
    el("div",{style:"font-weight:800; margin-bottom:8px;"}, "לוג פעילות"),
    buildActivity()
  );

  setMain([
    topCard,
    el("div",{class:"grid2"},
      voteCard,
      el("div",{class:"grid"},
        participantsCard,
        optionsCard
      )
    ),
    optCard,
    matrixCard,
    logCard
  ]);
}

function renderHomeOrMeeting(){
  const { meetingId } = parseUrl();
  if (!meetingId) renderHome();
  else renderMeeting(meetingId);
}

function boot(){
  qs("#homeBtn").addEventListener("click", ()=> { clearUrlMeeting(); renderHome(); });
  qs("#resetBtn").addEventListener("click", ()=> {
    if (!confirm("לאפס ולמחוק את כל הנתונים המקומיים?")) return;
    localStorage.removeItem(STORE_KEY);
    clearUrlMeeting();
    renderHome();
  });
  window.addEventListener("popstate", ()=> { renderHomeOrMeeting(); });
  renderHomeOrMeeting();
}
boot();
</script>
</body>
</html>
